(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[741],{41499:(e,t,r)=>{Promise.resolve().then(r.bind(r,51473))},51473:(e,t,r)=>{"use strict";r.d(t,{default:()=>d});var a=r(95155),s=r(12115),n=r(56847),l=r(93681),o=r(76046),c=r(48173),i=r.n(c);function d(e){let{lang:t}=e,r=(0,o.useRouter)(),[c,d]=(0,s.useState)([]),[m,h]=(0,s.useState)(null),[p,b]=(0,s.useState)([]),[g,v]=(0,s.useState)(""),[f,j]=(0,s.useState)(null),[y,w]=(0,s.useState)(null),N=(0,s.useRef)(null),k=(0,s.useRef)(!1),C=(0,s.useRef)(null);(0,s.useEffect)(()=>(k.current=!0,C.current=new Audio("/sounds/beep.mp3"),N.current=new n.BrowserMultiFormatReader,S(),()=>{k.current=!1,_()}),[]);let D=()=>{try{if(C.current)C.current.play().catch(()=>{});else{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator();t.connect(e.destination),t.frequency.value=800,t.start(),setTimeout(()=>t.stop(),100)}}catch(e){}},S=async()=>{try{var e;if(!window.isSecureContext&&"localhost"!==window.location.hostname)throw Error("HTTPS requis pour la cam\xe9ra");let t=await navigator.mediaDevices.getUserMedia({video:!0}),r=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);b(r),t.getTracks().forEach(e=>e.stop());let a=null===(e=r[0])||void 0===e?void 0:e.deviceId,s=r.find(e=>e.label.toLowerCase().includes("back")||e.label.toLowerCase().includes("environment")||e.label.toLowerCase().includes("arri\xe8re"));s&&(a=s.deviceId),r.length>0?(v(a||r[0].deviceId),E(a||r[0].deviceId)):h("Aucune cam\xe9ra d\xe9tect\xe9e (Permission OK pourtant).")}catch(e){console.error("Init Error",e),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?h("Permission cam\xe9ra refus\xe9e. D\xe9bloquez-la via l'ic\xf4ne \uD83D\uDD12."):"NotFoundError"===e.name?h("Aucune cam\xe9ra trouv\xe9e sur cet appareil."):h("".concat(e.name,": ").concat(e.message))}},E=async e=>{if(N.current)try{N.current.reset(),await N.current.decodeFromVideoDevice(e,"videoElement",(e,t)=>{e&&L(e.getText())}),h(null)}catch(e){console.error("Start Error",e),h("".concat(e.name,": ").concat(e.message))}},_=()=>{N.current&&N.current.reset()},z=async e=>{var t;let r=null===(t=e.target.files)||void 0===t?void 0:t[0];if(r&&N.current)try{let e=URL.createObjectURL(r),t=await N.current.decodeFromImageUrl(e);URL.revokeObjectURL(e),t&&L(t.getText())}catch(e){alert("Aucun code-barres trouv\xe9 dans l'image. Essayez de vous rapprocher.")}},L=e=>{d(t=>{if(t.length>0&&t[0].ean===e&&Date.now()-t[0].timestamp<2e3||t.find(t=>t.ean===e))return t;D();let r={ean:e,status:"loading",timestamp:Date.now()};return R(e),[r,...t]})},R=async e=>{try{let t=await l.u.get("/products/isbn/".concat(e));A(e,"found",t.data)}catch(t){A(e,"unknown")}},A=(e,t,r)=>{d(a=>a.map(a=>a.ean===e?{...a,status:t,product:r}:a))},F=async e=>{try{let{product:t,gamification:r}=(await l.u.post("/products/contribute",e,{headers:{"Content-Type":"multipart/form-data"}})).data,a=e.get("ean");d(e=>e.map(e=>e.ean===a?{...e,status:"contributed",product:t}:e));let s=(null==r?void 0:r.points_earned)||0;alert("Jeu ajout\xe9 ! +".concat(s," XP")),j(null)}catch(e){var t,r,a;console.error("Contribution Error",e),(null===(t=e.response)||void 0===t?void 0:t.status)===401?alert("Vous devez \xeatre connect\xe9 pour contribuer. Retournez au menu pour vous connecter."):alert("Erreur lors de l'ajout: "+((null===(a=e.response)||void 0===a?void 0:null===(r=a.data)||void 0===r?void 0:r.detail)||e.message))}},I=async e=>{if(y)try{await l.u.post("/products/".concat(e.id,"/ean?ean=").concat(y.ean)),d(t=>t.map(t=>t.ean===y.ean?{...t,status:"linked",product:e}:t)),alert("Code-barres associ\xe9 \xe0 ".concat(e.product_name," !")),w(null)}catch(e){var t,r,a;console.error("Link Error",e),(null===(t=e.response)||void 0===t?void 0:t.status)===401?alert("Vous devez \xeatre connect\xe9 pour contribuer."):alert("Erreur lors de l'association: "+((null===(a=e.response)||void 0===a?void 0:null===(r=a.data)||void 0===r?void 0:r.detail)||e.message))}};return(0,a.jsxs)("div",{className:"flex flex-col h-screen bg-black text-white overflow-hidden",children:[(0,a.jsxs)("div",{className:"relative h-[40%] bg-gray-900 border-b border-gray-800 overflow-hidden",children:[(0,a.jsx)("video",{id:"videoElement",className:"w-full h-full object-cover",style:{transform:"scaleX(1)"}}),m?(0,a.jsx)("div",{className:"absolute inset-0 z-50 bg-gray-900 flex items-center justify-center p-6 text-center",children:(0,a.jsxs)("div",{className:"max-w-xs w-full",children:[(0,a.jsx)("p",{className:"text-red-500 text-4xl mb-4",children:"\uD83D\uDD12 Acc\xe8s Bloqu\xe9"}),(0,a.jsxs)("div",{className:"bg-red-900/20 border border-red-500/30 p-3 rounded text-left text-xs text-red-200 mb-6",children:[(0,a.jsx)("p",{className:"font-bold mb-1",children:"Derni\xe8re chance :"}),(0,a.jsx)("p",{children:"Le syst\xe8me (Android/iOS) bloque peut-\xeatre Chrome. Essayez de scanner par photo ci-dessous."})]}),(0,a.jsxs)("label",{className:"block w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg shadow-lg cursor-pointer mb-3 flex items-center justify-center gap-2",children:[(0,a.jsx)("span",{children:"\uD83D\uDCF8 Scanner via Photo"}),(0,a.jsx)("input",{type:"file",accept:"image/*",capture:"environment",className:"hidden",onChange:z})]}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),className:"text-gray-500 text-xs underline",children:"R\xe9essayer le Live"})]})}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"absolute inset-0 pointer-events-none border-2 border-red-500/50 m-12 rounded-lg opacity-50 pulse-ring"}),(0,a.jsxs)("div",{className:"absolute bottom-2 right-2 flex gap-2 z-10",children:[(0,a.jsx)("span",{className:"px-2 py-1 bg-black/60 rounded text-[10px] text-green-400 font-mono self-center",children:"ZXING LIVE"}),p.length>0&&(0,a.jsx)("select",{className:"bg-black/60 text-white text-[10px] rounded px-1 max-w-[150px]",value:g,onChange:e=>{v(e.target.value),E(e.target.value)},children:p.map(e=>(0,a.jsx)("option",{value:e.deviceId,children:e.label||"Cam\xe9ra ".concat(e.deviceId.slice(0,5),"...")},e.deviceId))})]})]}),(0,a.jsx)(i(),{href:"/".concat(t),className:"absolute top-4 left-4 bg-black/50 p-2 rounded-full z-20",children:"✕"})]}),(0,a.jsxs)("div",{className:"flex-1 bg-gray-950 flex flex-col min-h-0",children:[(0,a.jsxs)("div",{className:"p-3 bg-gray-900 border-b border-gray-800 flex justify-between items-center shadow-lg z-10",children:[(0,a.jsxs)("h2",{className:"font-bold text-gray-200 text-sm",children:["Session (",c.length,")"]}),c.length>0&&(0,a.jsx)("button",{onClick:()=>r.push("/".concat(t,"/collection")),className:"text-xs bg-blue-600 px-3 py-1.5 rounded font-bold hover:bg-blue-500",children:"Terminer"})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-2 space-y-2",children:[0===c.length&&(0,a.jsxs)("div",{className:"text-center text-gray-600 mt-10",children:[(0,a.jsx)("p",{className:"text-4xl mb-2",children:"⬆️"}),(0,a.jsx)("p",{className:"text-sm",children:"Scannez un code-barres."})]}),c.map(e=>(0,a.jsxs)("div",{className:"bg-gray-900 rounded-lg p-3 flex gap-3 border border-gray-800",children:[(0,a.jsxs)("div",{className:"flex-shrink-0 pt-1",children:["loading"===e.status&&(0,a.jsx)("span",{className:"animate-spin block",children:"⏳"}),("found"===e.status||"linked"===e.status)&&(0,a.jsx)("span",{children:"✅"}),"contributed"===e.status&&(0,a.jsx)("span",{children:"\uD83C\uDFC6"}),"unknown"===e.status&&(0,a.jsx)("span",{className:"text-red-500",children:"❓"})]}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:["loading"===e.status&&(0,a.jsx)("p",{className:"text-gray-400 text-sm italic",children:"Recherche..."}),("found"===e.status||"contributed"===e.status||"linked"===e.status)&&e.product&&(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-bold text-white text-sm truncate",children:e.product.product_name}),(0,a.jsx)("p",{className:"text-gray-500 text-xs",children:e.product.console_name})]}),"unknown"===e.status&&(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-mono text-orange-400 text-sm",children:e.ean}),(0,a.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,a.jsx)("button",{onClick:()=>w(e),className:"flex-1 text-xs bg-blue-900/40 border border-blue-700/50 px-2 py-2 rounded text-blue-200 hover:bg-blue-800/50",children:"\uD83D\uDD0D Lier existant"}),(0,a.jsx)("button",{onClick:()=>j(e),className:"flex-1 text-xs bg-gray-800 border-gray-600 border px-2 py-2 rounded text-white hover:bg-gray-700",children:"+ Cr\xe9er"})]})]})]}),("found"===e.status||"contributed"===e.status||"linked"===e.status)&&e.product&&e.product.image_url&&(0,a.jsx)("img",{src:e.product.image_url,className:"w-12 h-16 object-cover rounded bg-gray-800",alt:""})]},e.ean))]})]}),f&&(0,a.jsx)(u,{item:f,onClose:()=>j(null),onSubmit:F}),y&&(0,a.jsx)(x,{item:y,onClose:()=>w(null),onSelect:I})]})}function u(e){let{item:t,onClose:r,onSubmit:n}=e,[l,o]=(0,s.useState)(""),[c,i]=(0,s.useState)(""),[d,u]=(0,s.useState)(null),[x,h]=(0,s.useState)(null),[p,b]=(0,s.useState)(!1);return(0,a.jsx)("div",{className:"fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-gray-900 rounded-xl w-full max-w-sm border border-orange-500/30 flex flex-col max-h-[90vh]",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-800 bg-gray-900 sticky top-0 rounded-t-xl z-20 flex justify-between",children:[(0,a.jsx)("h3",{className:"font-bold text-white",children:"Ajouter Nouveau"}),(0,a.jsx)("button",{onClick:r,className:"p-2",children:"✕"})]}),(0,a.jsxs)("div",{className:"p-4 space-y-4 overflow-y-auto",children:[(0,a.jsx)("p",{className:"text-orange-300 text-center font-mono",children:t.ean}),(0,a.jsx)("input",{className:"w-full bg-black border border-gray-700 rounded p-3 text-white",placeholder:"Nom du jeu",value:l,onChange:e=>o(e.target.value)}),(0,a.jsx)("input",{className:"w-full bg-black border border-gray-700 rounded p-3 text-white",placeholder:"Console (ex: PS2)",value:c,onChange:e=>i(e.target.value)}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsx)(m,{label:"Avant",file:d,setFile:u}),(0,a.jsx)(m,{label:"Arri\xe8re",file:x,setFile:h})]}),(0,a.jsx)("button",{disabled:!l||!c||p,onClick:()=>{if(!l||!c)return;b(!0);let e=new FormData;e.append("ean",t.ean),e.append("product_name",l),e.append("console_name",c),d&&e.append("front_image",d),x&&e.append("back_image",x),n(e)},className:"w-full bg-green-600 py-3 rounded font-bold text-white",children:p?"...":"Valider"})]})]})})}function x(e){let{item:t,onClose:r,onSelect:n}=e,[o,c]=(0,s.useState)(""),[i,d]=(0,s.useState)([]),[u,x]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{if(o.length<2){d([]);return}let e=setTimeout(async()=>{x(!0);try{let e=await l.u.get("/products/",{params:{search:o,limit:10}});d(e.data)}catch(e){console.error(e)}finally{x(!1)}},500);return()=>clearTimeout(e)},[o]),(0,a.jsxs)("div",{className:"fixed inset-0 z-50 bg-black/95 flex flex-col",children:[(0,a.jsxs)("div",{className:"p-4 bg-gray-900 flex items-center gap-3 border-b border-gray-800",children:[(0,a.jsx)("button",{onClick:r,className:"text-white text-xl",children:"←"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("h3",{className:"text-sm font-bold text-gray-400",children:["Lier le code ",t.ean," \xe0..."]}),(0,a.jsx)("input",{autoFocus:!0,className:"w-full bg-transparent text-white text-lg outline-none placeholder-gray-600",placeholder:"Chercher le jeu...",value:o,onChange:e=>c(e.target.value)})]})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:[u&&(0,a.jsx)("div",{className:"text-center p-4 text-gray-500",children:"Recherche..."}),!u&&0===i.length&&o.length>2&&(0,a.jsx)("div",{className:"text-center p-8 text-gray-600",children:"Aucun r\xe9sultat. Essayez un autre nom."}),i.map(e=>(0,a.jsxs)("button",{onClick:()=>n(e),className:"w-full bg-gray-800/50 p-3 rounded flex items-center gap-3 text-left hover:bg-gray-800",children:[e.image_url?(0,a.jsx)("img",{src:e.image_url,className:"w-10 h-14 object-cover rounded bg-black"}):(0,a.jsx)("div",{className:"w-10 h-14 bg-gray-700 rounded flex items-center justify-center text-xs text-gray-500",children:"?"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-bold text-white text-sm",children:e.product_name}),(0,a.jsx)("p",{className:"text-gray-400 text-xs",children:e.console_name})]})]},e.id))]})]})}function m(e){let{label:t,file:r,setFile:s}=e;return(0,a.jsxs)("label",{className:"block w-full aspect-square rounded border-2 border-dashed flex items-center justify-center cursor-pointer ".concat(r?"border-green-500":"border-gray-700"),children:[r?(0,a.jsx)("img",{src:URL.createObjectURL(r),className:"w-full h-full object-cover"}):(0,a.jsxs)("span",{children:["\uD83D\uDCF7 ",t]}),(0,a.jsx)("input",{type:"file",accept:"image/*",capture:"environment",className:"hidden",onChange:e=>{var t;return s((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)}})]})}},93681:(e,t,r)=>{"use strict";r.d(t,{H:()=>s,u:()=>n});var a=r(82651);let s="".concat("http://127.0.0.1:8000","/api/v1"),n=a.A.create({baseURL:s,timeout:12e4,headers:{"Content-Type":"application/json"}});n.interceptors.request.use(e=>{{let t=localStorage.getItem("rc_token");t&&(e.headers.Authorization="Bearer ".concat(t))}return e},e=>Promise.reject(e)),n.interceptors.response.use(e=>e,e=>Promise.reject(e))}},e=>{var t=t=>e(e.s=t);e.O(0,[651,173,260,441,517,358],()=>t(41499)),_N_E=e.O()}]);